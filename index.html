<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Imperial GTA Allocator</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // ============ CONFIGURATION - UPDATE THESE ============
        const CONFIG = {
            // Your Google Sheet ID (from the URL)
            // e.g., if URL is https://docs.google.com/spreadsheets/d/1ABC123xyz/edit
            // then the ID is: 1ABC123xyz
            SHEET_ID: '1CrBYLGlkkUNHwp_qRRC5NTlaOvs4x8s6lgftYCE18S4',
            
            // Your Google API Key
            API_KEY: 'AIzaSyBJT_1FknDO40X2HhU7uZEXnQlaPa-8emk',
            
            // Sheet names (tabs in your spreadsheet)
            SHEETS: {
                practicals: 'Practicals',
                submissions: 'Submissions', 
                allocations: 'Allocations',
                config: 'Config'
            }
        };

        // Google Sheets API helper
        const SheetsAPI = {
            baseUrl: 'https://sheets.googleapis.com/v4/spreadsheets',
            
            async readSheet(sheetName) {
                try {
                    const url = `${this.baseUrl}/${CONFIG.SHEET_ID}/values/${sheetName}?key=${CONFIG.API_KEY}`;
                    const response = await fetch(url);
                    if (!response.ok) {
                        console.error('Sheet read error:', response.status);
                        return [];
                    }
                    const data = await response.json();
                    if (!data.values || data.values.length < 2) return [];
                    
                    const headers = data.values[0];
                    const rows = data.values.slice(1);
                    return rows.map(row => {
                        const obj = {};
                        headers.forEach((header, i) => {
                            obj[header] = row[i] || '';
                        });
                        return obj;
                    });
                } catch (error) {
                    console.error('Error reading sheet:', error);
                    return [];
                }
            },
            
            async appendRow(sheetName, rowData) {
                try {
                    const url = `${this.baseUrl}/${CONFIG.SHEET_ID}/values/${sheetName}:append?valueInputOption=USER_ENTERED&key=${CONFIG.API_KEY}`;
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ values: [rowData] })
                    });
                    return response.ok;
                } catch (error) {
                    console.error('Error appending row:', error);
                    return false;
                }
            },
            
            async writeSheet(sheetName, data, headers) {
                try {
                    const values = [headers, ...data.map(row => headers.map(h => row[h] || ''))];
                    const url = `${this.baseUrl}/${CONFIG.SHEET_ID}/values/${sheetName}?valueInputOption=USER_ENTERED&key=${CONFIG.API_KEY}`;
                    const response = await fetch(url, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ values })
                    });
                    return response.ok;
                } catch (error) {
                    console.error('Error writing sheet:', error);
                    return false;
                }
            }
        };

        // For write operations, we need a different approach since API key alone is read-only
        // We'll use a Google Apps Script Web App as a proxy for writes
        const SheetsWriter = {
            // This will be your deployed Google Apps Script URL
            webAppUrl: '', // Will be set from Config sheet
            
            async init() {
                // Try to read the web app URL from the config sheet
                const config = await SheetsAPI.readSheet(CONFIG.SHEETS.config);
                if (config.length > 0 && config[0].webAppUrl) {
                    this.webAppUrl = config[0].webAppUrl;
                }
            },
            
            async write(action, sheetName, data) {
                if (!this.webAppUrl) {
                    console.error('Web App URL not configured');
                    alert('Backend not configured. Please set up the Google Apps Script Web App.');
                    return false;
                }
                
                try {
                    const response = await fetch(this.webAppUrl, {
                        method: 'POST',
                        mode: 'no-cors', // Required for Apps Script
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action, sheetName, data })
                    });
                    return true; // no-cors doesn't give us response details
                } catch (error) {
                    console.error('Error writing:', error);
                    return false;
                }
            },
            
            async append(sheetName, rowData) {
                return this.write('append', sheetName, rowData);
            },
            
            async update(sheetName, allData) {
                return this.write('update', sheetName, allData);
            },
            
            async deleteRow(sheetName, id) {
                return this.write('delete', sheetName, { id });
            }
        };

        // Lucide icons as SVG components
        const Calendar = ({ size = 24, className = "" }) => (
            <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
        );

        const Users = ({ size = 24, className = "" }) => (
            <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
        );

        const Settings = ({ size = 24, className = "" }) => (
            <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </svg>
        );

        const CheckCircle = ({ size = 24, className = "" }) => (
            <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
        );

        const AlertCircle = ({ size = 24, className = "" }) => (
            <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
        );

        const Download = ({ size = 24, className = "" }) => (
            <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
        );
        
        const RefreshCw = ({ size = 24, className = "" }) => (
            <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polyline points="23 4 23 10 17 10"></polyline>
                <polyline points="1 20 1 14 7 14"></polyline>
                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
            </svg>
        );
        
        const Cloud = ({ size = 24, className = "" }) => (
            <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path>
            </svg>
        );

        const GTAAllocator = () => {
            const [view, setView] = useState('student');
            const [isAdminAuthenticated, setIsAdminAuthenticated] = useState(false);
            const [studentName, setStudentName] = useState('');
            const [studentEmail, setStudentEmail] = useState('');
            const [practicals, setPracticals] = useState([]);
            const [preferences, setPreferences] = useState([]);
            const [submissions, setSubmissions] = useState([]);
            const [allocations, setAllocations] = useState([]);
            const [maxSlotsPerStudent, setMaxSlotsPerStudent] = useState(3);
            const [expertiseTags, setExpertiseTags] = useState([
                'eukaryotic cell culture wet lab work', 'molecular biology wet lab work',
                'microbiology lab work', 'ecology',
                'evolutionary biology', 'statistics and programming (e.g. Python and R)',
                'maths support', 'widening access support activities',
                'developmental biology', 'Drosophila'
            ]);
            const [isLoading, setIsLoading] = useState(true);
            const [isOnline, setIsOnline] = useState(false);
            const [lastSync, setLastSync] = useState(null);
            
            const getAdminPassword = () => atob('==QNyAjMTBFR'.split('').reverse().join(''));

            // Check if Google Sheets is configured
            const isConfigured = CONFIG.SHEET_ID !== 'YOUR_SHEET_ID_HERE' && CONFIG.API_KEY !== 'YOUR_API_KEY_HERE';

            // Load data from Google Sheets
            const loadFromSheets = async () => {
                if (!isConfigured) {
                    setIsLoading(false);
                    return;
                }
                
                setIsLoading(true);
                try {
                    await SheetsWriter.init();
                    
                    const [practicalsData, submissionsData, allocationsData] = await Promise.all([
                        SheetsAPI.readSheet(CONFIG.SHEETS.practicals),
                        SheetsAPI.readSheet(CONFIG.SHEETS.submissions),
                        SheetsAPI.readSheet(CONFIG.SHEETS.allocations)
                    ]);
                    
                    // Convert practicals data
                    const convertedPracticals = practicalsData.map(p => ({
                        ...p,
                        id: p.id || Date.now().toString(),
                        slots: parseInt(p.slots) || 5,
                        tags: p.tags ? p.tags.split(',').map(t => t.trim()).filter(t => t) : []
                    }));
                    
                    // Convert submissions data  
                    const convertedSubmissions = submissionsData.map(s => ({
                        ...s,
                        id: s.id || Date.now().toString(),
                        preferences: s.preferences ? s.preferences.split(',').map(t => t.trim()) : [],
                        expertise: s.expertise ? s.expertise.split(',').map(t => t.trim()) : [],
                        previousHours: parseInt(s.previousHours) || 0
                    }));
                    
                    // Convert allocations data
                    const convertedAllocations = allocationsData.map(a => ({
                        ...a,
                        preferenceRank: parseInt(a.preferenceRank) || 1,
                        round: parseInt(a.round) || 1,
                        expertiseMatch: parseInt(a.expertiseMatch) || 0
                    }));
                    
                    setPracticals(convertedPracticals);
                    setSubmissions(convertedSubmissions);
                    setAllocations(convertedAllocations);
                    setIsOnline(true);
                    setLastSync(new Date());
                } catch (error) {
                    console.error('Error loading from sheets:', error);
                    setIsOnline(false);
                }
                setIsLoading(false);
            };

            useEffect(() => {
                loadFromSheets();
            }, []);

            // Save practical to Google Sheets
            const addPractical = async (practical) => {
                const newPractical = {
                    ...practical,
                    id: Date.now().toString(),
                    deadline: practical.deadline || practical.date,
                    tags: practical.tags || []
                };
                
                // Optimistic update
                const newPracticals = [...practicals, newPractical];
                setPracticals(newPracticals);
                
                if (isConfigured && SheetsWriter.webAppUrl) {
                    const rowData = {
                        id: newPractical.id,
                        name: newPractical.name,
                        courseCode: newPractical.courseCode || '',
                        date: newPractical.date,
                        deadline: newPractical.deadline,
                        slots: newPractical.slots,
                        tags: newPractical.tags.join(', ')
                    };
                    await SheetsWriter.append(CONFIG.SHEETS.practicals, rowData);
                }
            };

            const deletePractical = async (id) => {
                const newPracticals = practicals.filter(p => p.id !== id);
                setPracticals(newPracticals);
                
                if (isConfigured && SheetsWriter.webAppUrl) {
                    await SheetsWriter.deleteRow(CONFIG.SHEETS.practicals, id);
                }
            };

            const updatePractical = async (updatedPractical) => {
                const newPracticals = practicals.map(p => 
                    p.id === updatedPractical.id ? updatedPractical : p
                );
                setPracticals(newPracticals);
                
                if (isConfigured && SheetsWriter.webAppUrl) {
                    const allData = newPracticals.map(p => ({
                        id: p.id,
                        name: p.name,
                        courseCode: p.courseCode || '',
                        date: p.date,
                        deadline: p.deadline || p.date,
                        slots: p.slots,
                        tags: Array.isArray(p.tags) ? p.tags.join(', ') : p.tags
                    }));
                    await SheetsWriter.update(CONFIG.SHEETS.practicals, allData);
                }
            };

            const submitPreferences = async () => {
                const selectedTags = Array.from(document.querySelectorAll('input[name="expertise"]:checked'))
                    .map(cb => cb.value);
                
                if (!studentName || !studentEmail || preferences.length === 0) {
                    alert('Please fill in your name, email, and select at least one preference');
                    return;
                }

                if (selectedTags.length === 0) {
                    alert('Please select at least one area of expertise/interest');
                    return;
                }

                const submission = {
                    id: Date.now().toString(),
                    name: studentName,
                    email: studentEmail,
                    preferences: preferences,
                    expertise: selectedTags,
                    timestamp: new Date().toISOString(),
                    previousHours: 0
                };

                // Optimistic update
                const newSubmissions = [...submissions, submission];
                setSubmissions(newSubmissions);
                
                if (isConfigured && SheetsWriter.webAppUrl) {
                    const rowData = {
                        id: submission.id,
                        name: submission.name,
                        email: submission.email,
                        preferences: submission.preferences.join(', '),
                        expertise: submission.expertise.join(', '),
                        timestamp: submission.timestamp,
                        previousHours: submission.previousHours
                    };
                    await SheetsWriter.append(CONFIG.SHEETS.submissions, rowData);
                }
                
                setPreferences([]);
                alert('Your preferences have been submitted successfully!');
            };

            const runAllocation = async () => {
                const results = [];
                const studentAllocations = {};
                const practicalFills = {};
                
                practicals.forEach(p => { practicalFills[p.id] = 0; });
                submissions.forEach(s => { studentAllocations[s.email] = 0; });

                const sortedStudents = [...submissions].sort((a, b) => 
                    (a.previousHours || 0) - (b.previousHours || 0)
                );

                for (let round = 1; round <= maxSlotsPerStudent; round++) {
                    for (const student of sortedStudents) {
                        if (studentAllocations[student.email] >= round) continue;
                        
                        for (let prefIdx = 0; prefIdx < student.preferences.length; prefIdx++) {
                            const practicalId = student.preferences[prefIdx];
                            const practical = practicals.find(p => p.id === practicalId);
                            
                            if (!practical) continue;
                            if (practicalFills[practicalId] >= practical.slots) continue;
                            
                            const alreadyAllocated = results.some(
                                r => r.studentEmail === student.email && r.practicalId === practicalId
                            );
                            if (alreadyAllocated) continue;

                            let expertiseMatch = 0;
                            if (practical.tags && student.expertise) {
                                const practicalTags = Array.isArray(practical.tags) ? practical.tags : [];
                                const studentExpertise = Array.isArray(student.expertise) ? student.expertise : [];
                                expertiseMatch = practicalTags.filter(t => 
                                    studentExpertise.includes(t)
                                ).length;
                            }

                            results.push({
                                studentName: student.name,
                                studentEmail: student.email,
                                practicalId: practicalId,
                                practicalName: practical.name,
                                practicalDate: practical.date,
                                courseCode: practical.courseCode || '',
                                preferenceRank: prefIdx + 1,
                                round: round,
                                expertiseMatch: expertiseMatch
                            });

                            studentAllocations[student.email]++;
                            practicalFills[practicalId]++;
                            break;
                        }
                    }
                }

                setAllocations(results);
                
                // Save to Google Sheets
                if (isConfigured && SheetsWriter.webAppUrl) {
                    await SheetsWriter.update(CONFIG.SHEETS.allocations, results);
                }
                
                alert(`Allocation complete! ${results.length} slots allocated to ${new Set(results.map(r => r.studentEmail)).size} students.`);
            };

            const exportAllocations = () => {
                const csv = [
                    ['Student Name', 'Email', 'Practical', 'Course Code', 'Date', 'Preference Rank', 'Round', 'Expertise Match'].join(','),
                    ...allocations.map(a => [
                        a.studentName,
                        a.studentEmail,
                        a.practicalName,
                        a.courseCode || '',
                        a.practicalDate,
                        a.preferenceRank,
                        a.round,
                        a.expertiseMatch || 0
                    ].join(','))
                ].join('\n');

                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'gta-allocations.csv';
                a.click();
            };

            // Connection status banner
            const ConnectionStatus = () => {
                if (!isConfigured) {
                    return (
                        <div className="bg-yellow-100 border-b border-yellow-300 px-4 py-2 text-center text-yellow-800 text-sm">
                            ⚠️ Google Sheets not configured - using local storage only. 
                            <a href="#setup" className="underline ml-1">Setup instructions</a>
                        </div>
                    );
                }
                
                return (
                    <div className={`${isOnline ? 'bg-green-100 border-green-300 text-green-800' : 'bg-red-100 border-red-300 text-red-800'} border-b px-4 py-2 text-center text-sm flex items-center justify-center gap-2`}>
                        <Cloud size={16} />
                        {isOnline ? (
                            <>
                                Connected to Google Sheets
                                {lastSync && <span className="text-xs opacity-75">• Last sync: {lastSync.toLocaleTimeString()}</span>}
                                <button onClick={loadFromSheets} className="ml-2 p-1 hover:bg-green-200 rounded" title="Refresh data">
                                    <RefreshCw size={14} />
                                </button>
                            </>
                        ) : (
                            'Unable to connect to Google Sheets - working offline'
                        )}
                    </div>
                );
            };

            const StudentView = () => {
                const now = new Date();
                const availablePracticals = practicals.filter(p => {
                    const deadline = new Date(p.deadline || p.date);
                    return now < deadline;
                });
                const isWindowOpen = availablePracticals.length > 0;
                
                const checkEmail = studentEmail.toLowerCase().trim();
                const myAllocations = allocations.filter(a => a.studentEmail.toLowerCase() === checkEmail);

                return (
                    <div className="max-w-4xl mx-auto p-6">
                        <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                            <h2 className="text-2xl font-bold text-blue-900 mb-2">GTA Practical Allocation System</h2>
                            <p className="text-blue-700">
                                {availablePracticals.length > 0 
                                    ? `${availablePracticals.length} practical(s) currently open for signup`
                                    : 'No practicals currently open for signup'}
                            </p>
                        </div>

                        {availablePracticals.length > 0 ? (
                            <div className="bg-white rounded-lg shadow-md p-6 mb-6">
                                <h3 className="text-xl font-semibold mb-4">Submit Your Preferences</h3>
                                
                                <div className="mb-4">
                                    <label className="block text-sm font-medium mb-2">Your Name</label>
                                    <input
                                        type="text"
                                        defaultValue={studentName}
                                        onBlur={(e) => setStudentName(e.target.value)}
                                        className="w-full p-2 border rounded"
                                        placeholder="Full name"
                                    />
                                </div>

                                <div className="mb-4">
                                    <label className="block text-sm font-medium mb-2">Imperial Email</label>
                                    <input
                                        type="email"
                                        defaultValue={studentEmail}
                                        onBlur={(e) => setStudentEmail(e.target.value)}
                                        className="w-full p-2 border rounded"
                                        placeholder="your.name@imperial.ac.uk"
                                    />
                                </div>

                                <div className="mb-4">
                                    <label className="block text-sm font-medium mb-2">Your Areas of Expertise/Interest (select all that apply)</label>
                                    <div className="border rounded p-3 bg-gray-50 max-h-40 overflow-y-auto">
                                        <div className="grid grid-cols-2 md:grid-cols-2 gap-2">
                                            {expertiseTags.map(tag => (
                                                <label key={tag} className="flex items-center space-x-2">
                                                    <input type="checkbox" name="expertise" value={tag} className="w-4 h-4" />
                                                    <span className="text-sm">{tag}</span>
                                                </label>
                                            ))}
                                        </div>
                                    </div>
                                </div>

                                <div className="mb-4">
                                    <label className="block text-sm font-medium mb-2">
                                        Select Practicals (click to rank in order of preference)
                                    </label>
                                    <div className="space-y-2">
                                        {availablePracticals.map(practical => {
                                            const prefIndex = preferences.indexOf(practical.id);
                                            const isSelected = prefIndex !== -1;
                                            return (
                                                <div
                                                    key={practical.id}
                                                    onClick={() => {
                                                        if (isSelected) {
                                                            setPreferences(preferences.filter(id => id !== practical.id));
                                                        } else {
                                                            setPreferences([...preferences, practical.id]);
                                                        }
                                                    }}
                                                    className={`p-3 border rounded cursor-pointer transition-colors ${
                                                        isSelected 
                                                            ? 'bg-blue-100 border-blue-500' 
                                                            : 'hover:bg-gray-50'
                                                    }`}
                                                >
                                                    <div className="flex justify-between items-center">
                                                        <div>
                                                            <span className="font-medium">{practical.name}</span>
                                                            {practical.courseCode && (
                                                                <span className="ml-2 text-purple-600 text-sm">({practical.courseCode})</span>
                                                            )}
                                                            <span className="text-gray-500 ml-2">
                                                                ({new Date(practical.date).toLocaleDateString()})
                                                            </span>
                                                            {practical.tags && practical.tags.length > 0 && (
                                                                <div className="flex flex-wrap gap-1 mt-1">
                                                                    {practical.tags.map(tag => (
                                                                        <span key={tag} className="text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded">
                                                                            {tag}
                                                                        </span>
                                                                    ))}
                                                                </div>
                                                            )}
                                                        </div>
                                                        {isSelected && (
                                                            <span className="bg-blue-600 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold">
                                                                {prefIndex + 1}
                                                            </span>
                                                        )}
                                                    </div>
                                                    <div className="text-sm text-gray-500 mt-1">
                                                        {practical.slots} slots • Deadline: {new Date(practical.deadline || practical.date).toLocaleDateString()}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>

                                {preferences.length > 0 && (
                                    <div className="mb-4 p-3 bg-blue-50 rounded">
                                        <strong>Your ranking:</strong>{' '}
                                        {preferences.map((id, idx) => {
                                            const p = practicals.find(pr => pr.id === id);
                                            return p ? `${idx + 1}. ${p.name}` : '';
                                        }).join(' → ')}
                                    </div>
                                )}

                                <button
                                    onClick={submitPreferences}
                                    disabled={preferences.length === 0}
                                    className="bg-blue-600 text-white px-6 py-3 rounded font-medium hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed"
                                >
                                    Submit Preferences
                                </button>
                            </div>
                        ) : (
                            <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-6 mb-6">
                                <AlertCircle className="text-yellow-600 mb-2" />
                                <p className="text-yellow-800">No practicals are currently open for signup. Check back later or contact the DPS.</p>
                            </div>
                        )}

                        <div className="bg-white rounded-lg shadow-md p-6">
                            <h3 className="text-xl font-semibold mb-4">Check Your Allocations</h3>
                            <div className="mb-4">
                                <input
                                    type="email"
                                    placeholder="Enter your email to check allocations"
                                    defaultValue={studentEmail}
                                    onBlur={(e) => setStudentEmail(e.target.value)}
                                    className="w-full p-2 border rounded"
                                />
                            </div>
                            
                            {myAllocations.length > 0 ? (
                                <div className="space-y-2">
                                    {myAllocations.map((alloc, idx) => (
                                        <div key={idx} className="p-3 bg-green-50 border border-green-200 rounded">
                                            <div className="font-medium">{alloc.practicalName}</div>
                                            <div className="text-sm text-gray-600">
                                                {alloc.courseCode && <span className="text-purple-600 font-medium">{alloc.courseCode} • </span>}
                                                {new Date(alloc.practicalDate).toLocaleDateString()} • 
                                                Preference rank: {alloc.preferenceRank}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <p className="text-gray-500">
                                    {studentEmail ? 'No allocations found for this email.' : 'Enter your email above to check.'}
                                </p>
                            )}
                        </div>
                    </div>
                );
            };

            const AdminView = () => {
                const [newPractical, setNewPractical] = useState({ name: '', date: '', slots: 5, deadline: '', tags: [], courseCode: '' });
                const [editingPractical, setEditingPractical] = useState(null);

                if (!isAdminAuthenticated) {
                    const checkPassword = () => {
                        const password = prompt('Enter admin password:');
                        if (password === getAdminPassword()) {
                            setIsAdminAuthenticated(true);
                        } else if (password !== null) {
                            alert('Incorrect password');
                        }
                    };

                    setTimeout(checkPassword, 100);

                    return (
                        <div className="max-w-md mx-auto p-6 mt-20">
                            <div className="bg-white rounded-lg shadow-md p-8 text-center">
                                <h2 className="text-2xl font-bold text-purple-900 mb-4">Admin Login Required</h2>
                                <p className="text-gray-600 mb-4">You'll be prompted for the admin password.</p>
                                <button
                                    onClick={checkPassword}
                                    className="bg-purple-600 text-white px-6 py-2 rounded hover:bg-purple-700"
                                >
                                    Enter Password
                                </button>
                            </div>
                        </div>
                    );
                }

                return (
                    <div className="max-w-6xl mx-auto p-6">
                        <div className="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-6">
                            <div className="flex justify-between items-center">
                                <div>
                                    <h2 className="text-2xl font-bold text-purple-900 mb-2">Admin Dashboard</h2>
                                    <p className="text-purple-700">Manage practicals and run allocations</p>
                                </div>
                                <div className="flex gap-2">
                                    <button
                                        onClick={loadFromSheets}
                                        className="bg-purple-100 text-purple-700 px-4 py-2 rounded hover:bg-purple-200 flex items-center gap-2"
                                        title="Refresh data from Google Sheets"
                                    >
                                        <RefreshCw size={16} />
                                        Refresh
                                    </button>
                                    <button
                                        onClick={() => {
                                            setIsAdminAuthenticated(false);
                                            setView('student');
                                        }}
                                        className="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700"
                                    >
                                        Logout
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div className="bg-white rounded-lg shadow-md p-6 mb-6">
                            <h3 className="text-xl font-semibold mb-4">System Settings</h3>
                            
                            <div className="mb-6">
                                <label className="block text-sm font-medium mb-2">Max Slots per Student</label>
                                <input
                                    type="number"
                                    min="1"
                                    max="10"
                                    value={maxSlotsPerStudent}
                                    onChange={(e) => setMaxSlotsPerStudent(parseInt(e.target.value))}
                                    className="w-full p-2 border rounded"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium mb-2">Expertise Tags</label>
                                <div className="flex gap-2 mb-3">
                                    <input
                                        id="new-tag-input"
                                        type="text"
                                        placeholder="Add new expertise tag"
                                        className="flex-1 p-2 border rounded"
                                    />
                                    <button
                                        onClick={() => {
                                            const input = document.getElementById('new-tag-input');
                                            const newTag = input.value.trim();
                                            if (newTag && !expertiseTags.includes(newTag)) {
                                                setExpertiseTags([...expertiseTags, newTag]);
                                                input.value = '';
                                            }
                                        }}
                                        className="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700"
                                    >
                                        Add Tag
                                    </button>
                                </div>
                                <div className="flex flex-wrap gap-2">
                                    {expertiseTags.map(tag => (
                                        <span key={tag} className="bg-purple-100 text-purple-700 px-3 py-1 rounded-full text-sm flex items-center gap-2">
                                            {tag}
                                            <button
                                                onClick={() => setExpertiseTags(expertiseTags.filter(t => t !== tag))}
                                                className="text-purple-900 hover:text-purple-600 font-bold"
                                            >
                                                ×
                                            </button>
                                        </span>
                                    ))}
                                </div>
                            </div>
                        </div>

                        <div className="bg-white rounded-lg shadow-md p-6 mb-6">
                            <h3 className="text-xl font-semibold mb-4">Add Practical</h3>
                            
                            <div className="grid grid-cols-5 gap-4 mb-4">
                                <div>
                                    <label className="block text-sm font-medium mb-2">Practical Name</label>
                                    <input
                                        type="text"
                                        value={newPractical.name}
                                        onChange={(e) => setNewPractical({ ...newPractical, name: e.target.value })}
                                        className="w-full p-2 border rounded"
                                        placeholder="e.g., Genetics Lab Week 3"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium mb-2">Course Code</label>
                                    <input
                                        type="text"
                                        value={newPractical.courseCode}
                                        onChange={(e) => setNewPractical({ ...newPractical, courseCode: e.target.value })}
                                        className="w-full p-2 border rounded"
                                        placeholder="e.g., BIOL50001"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium mb-2">Practical Date</label>
                                    <input
                                        type="date"
                                        value={newPractical.date}
                                        onChange={(e) => setNewPractical({ ...newPractical, date: e.target.value })}
                                        className="w-full p-2 border rounded"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium mb-2">Signup Deadline</label>
                                    <input
                                        type="date"
                                        value={newPractical.deadline}
                                        onChange={(e) => setNewPractical({ ...newPractical, deadline: e.target.value })}
                                        className="w-full p-2 border rounded"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium mb-2">GTA Slots</label>
                                    <input
                                        type="number"
                                        min="1"
                                        value={newPractical.slots}
                                        onChange={(e) => setNewPractical({ ...newPractical, slots: parseInt(e.target.value) })}
                                        className="w-full p-2 border rounded"
                                    />
                                </div>
                            </div>

                            <div className="mb-4">
                                <label className="block text-sm font-medium mb-2">Relevant Expertise Tags (optional)</label>
                                <div className="border rounded p-3 bg-gray-50 max-h-32 overflow-y-auto">
                                    <div className="grid grid-cols-3 gap-2">
                                        {expertiseTags.map(tag => (
                                            <label key={tag} className="flex items-center space-x-2">
                                                <input 
                                                    type="checkbox"
                                                    checked={newPractical.tags?.includes(tag)}
                                                    onChange={(e) => {
                                                        const tags = e.target.checked
                                                            ? [...(newPractical.tags || []), tag]
                                                            : (newPractical.tags || []).filter(t => t !== tag);
                                                        setNewPractical({ ...newPractical, tags });
                                                    }}
                                                    className="w-4 h-4"
                                                />
                                                <span className="text-sm">{tag}</span>
                                            </label>
                                        ))}
                                    </div>
                                </div>
                            </div>

                            <button
                                onClick={() => {
                                    if (newPractical.name && newPractical.date) {
                                        addPractical(newPractical);
                                        setNewPractical({ name: '', date: '', slots: 5, deadline: '', tags: [], courseCode: '' });
                                    }
                                }}
                                className="bg-purple-600 text-white px-6 py-2 rounded hover:bg-purple-700"
                            >
                                Add Practical
                            </button>
                        </div>

                        <div className="bg-white rounded-lg shadow-md p-6 mb-6">
                            <h3 className="text-xl font-semibold mb-4">Current Practicals ({practicals.length})</h3>
                            {practicals.length === 0 ? (
                                <p className="text-gray-500">No practicals added yet</p>
                            ) : (
                                <div className="space-y-2">
                                    {practicals.map(practical => {
                                        const deadline = new Date(practical.deadline || practical.date);
                                        const isOpen = new Date() < deadline;
                                        return (
                                            <div key={practical.id} className="flex justify-between items-start p-3 bg-gray-50 rounded">
                                                <div className="flex-1">
                                                    <div className="font-medium">{practical.name}</div>
                                                    <div className="text-sm text-gray-600">
                                                        {practical.courseCode && <span className="font-medium text-purple-600">{practical.courseCode} • </span>}
                                                        Practical: {new Date(practical.date).toLocaleDateString()} • 
                                                        Deadline: {deadline.toLocaleDateString()} • 
                                                        {practical.slots} slots
                                                    </div>
                                                    <div className="flex items-center gap-2 mt-1">
                                                        <span className={`text-xs px-2 py-1 rounded ${isOpen ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                                            {isOpen ? 'Open for signup' : 'Signup closed'}
                                                        </span>
                                                        {practical.tags && practical.tags.length > 0 && (
                                                            <div className="flex flex-wrap gap-1">
                                                                {practical.tags.map(tag => (
                                                                    <span key={tag} className="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded">
                                                                        {tag}
                                                                    </span>
                                                                ))}
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                                <div className="flex gap-2 ml-4">
                                                    <button
                                                        onClick={() => setEditingPractical({...practical})}
                                                        className="text-blue-600 hover:text-blue-800 px-3 py-1 border border-blue-300 rounded text-sm"
                                                    >
                                                        Edit
                                                    </button>
                                                    <button
                                                        onClick={() => {
                                                            if (confirm('Delete this practical?')) {
                                                                deletePractical(practical.id);
                                                            }
                                                        }}
                                                        className="text-red-600 hover:text-red-800 px-3 py-1 border border-red-300 rounded text-sm"
                                                    >
                                                        Delete
                                                    </button>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            )}
                        </div>

                        {/* Edit Practical Modal */}
                        {editingPractical && (
                            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                                <div className="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl mx-4">
                                    <h3 className="text-xl font-semibold mb-4">Edit Practical</h3>
                                    
                                    <div className="grid grid-cols-2 gap-4 mb-4">
                                        <div>
                                            <label className="block text-sm font-medium mb-2">Practical Name</label>
                                            <input
                                                type="text"
                                                value={editingPractical.name}
                                                onChange={(e) => setEditingPractical({ ...editingPractical, name: e.target.value })}
                                                className="w-full p-2 border rounded"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium mb-2">Course Code</label>
                                            <input
                                                type="text"
                                                value={editingPractical.courseCode || ''}
                                                onChange={(e) => setEditingPractical({ ...editingPractical, courseCode: e.target.value })}
                                                className="w-full p-2 border rounded"
                                                placeholder="e.g., BIOL50001"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium mb-2">Practical Date</label>
                                            <input
                                                type="date"
                                                value={editingPractical.date}
                                                onChange={(e) => setEditingPractical({ ...editingPractical, date: e.target.value })}
                                                className="w-full p-2 border rounded"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium mb-2">Signup Deadline</label>
                                            <input
                                                type="date"
                                                value={editingPractical.deadline || editingPractical.date}
                                                onChange={(e) => setEditingPractical({ ...editingPractical, deadline: e.target.value })}
                                                className="w-full p-2 border rounded"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium mb-2">GTA Slots</label>
                                            <input
                                                type="number"
                                                min="1"
                                                value={editingPractical.slots}
                                                onChange={(e) => setEditingPractical({ ...editingPractical, slots: parseInt(e.target.value) })}
                                                className="w-full p-2 border rounded"
                                            />
                                        </div>
                                    </div>

                                    <div className="mb-4">
                                        <label className="block text-sm font-medium mb-2">Relevant Expertise Tags</label>
                                        <div className="border rounded p-3 bg-gray-50 max-h-32 overflow-y-auto">
                                            <div className="grid grid-cols-3 gap-2">
                                                {expertiseTags.map(tag => (
                                                    <label key={tag} className="flex items-center space-x-2">
                                                        <input 
                                                            type="checkbox"
                                                            checked={editingPractical.tags?.includes(tag)}
                                                            onChange={(e) => {
                                                                const tags = e.target.checked
                                                                    ? [...(editingPractical.tags || []), tag]
                                                                    : (editingPractical.tags || []).filter(t => t !== tag);
                                                                setEditingPractical({ ...editingPractical, tags });
                                                            }}
                                                            className="w-4 h-4"
                                                        />
                                                        <span className="text-sm">{tag}</span>
                                                    </label>
                                                ))}
                                            </div>
                                        </div>
                                    </div>

                                    <div className="flex justify-end gap-3">
                                        <button
                                            onClick={() => setEditingPractical(null)}
                                            className="px-4 py-2 border border-gray-300 rounded hover:bg-gray-50"
                                        >
                                            Cancel
                                        </button>
                                        <button
                                            onClick={() => {
                                                updatePractical(editingPractical);
                                                setEditingPractical(null);
                                            }}
                                            className="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700"
                                        >
                                            Save Changes
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        <div className="bg-white rounded-lg shadow-md p-6 mb-6">
                            <h3 className="text-xl font-semibold mb-4">Student Submissions ({submissions.length})</h3>
                            <div className="space-y-2 max-h-64 overflow-y-auto">
                                {submissions.map(sub => (
                                    <div key={sub.id} className="p-3 bg-blue-50 rounded">
                                        <div className="font-medium">{sub.name} ({sub.email})</div>
                                        <div className="text-sm text-gray-600">
                                            Submitted: {new Date(sub.timestamp).toLocaleString()}
                                        </div>
                                        {sub.expertise && sub.expertise.length > 0 && (
                                            <div className="text-sm mt-1">
                                                <span className="font-medium">Expertise: </span>
                                                {Array.isArray(sub.expertise) ? sub.expertise.join(', ') : sub.expertise}
                                            </div>
                                        )}
                                        <div className="text-sm mt-1">
                                            <span className="font-medium">Preferences: </span>
                                            {(Array.isArray(sub.preferences) ? sub.preferences : []).map((prefId, idx) => {
                                                const practical = practicals.find(p => p.id === prefId);
                                                return practical ? `${idx + 1}. ${practical.name}` : '';
                                            }).filter(p => p).join(' • ')}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        <div className="bg-white rounded-lg shadow-md p-6 mb-6">
                            <h3 className="text-xl font-semibold mb-4">Run Allocation</h3>
                            <p className="text-gray-600 mb-4">
                                This will allocate students to practicals based on their preferences and expertise match.
                            </p>
                            <button
                                onClick={runAllocation}
                                className="bg-green-600 text-white px-6 py-3 rounded font-medium hover:bg-green-700"
                            >
                                Run Fair Allocation Algorithm
                            </button>
                        </div>

                        {allocations.length > 0 && (
                            <div className="bg-white rounded-lg shadow-md p-6">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-xl font-semibold">Allocation Results ({allocations.length} total slots)</h3>
                                    <button
                                        onClick={exportAllocations}
                                        className="flex items-center bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
                                    >
                                        <Download size={20} className="mr-2" />
                                        Export CSV
                                    </button>
                                </div>
                                
                                <div className="grid grid-cols-3 gap-4 mb-4 p-4 bg-gray-50 rounded">
                                    <div>
                                        <div className="text-2xl font-bold text-blue-600">
                                            {new Set(allocations.map(a => a.studentEmail)).size}
                                        </div>
                                        <div className="text-sm text-gray-600">Students allocated</div>
                                    </div>
                                    <div>
                                        <div className="text-2xl font-bold text-green-600">
                                            {allocations.length > 0 ? (allocations.reduce((sum, a) => sum + (a.preferenceRank === 1 ? 1 : 0), 0) / allocations.length * 100).toFixed(0) : 0}%
                                        </div>
                                        <div className="text-sm text-gray-600">Got 1st choice</div>
                                    </div>
                                    <div>
                                        <div className="text-2xl font-bold text-purple-600">
                                            {submissions.length > 0 ? (allocations.length / submissions.length).toFixed(1) : 0}
                                        </div>
                                        <div className="text-sm text-gray-600">Avg slots per student</div>
                                    </div>
                                </div>

                                <div className="space-y-2 max-h-96 overflow-y-auto">
                                    {allocations.map((alloc, idx) => (
                                        <div key={idx} className="p-3 bg-green-50 border border-green-200 rounded">
                                            <div className="flex justify-between">
                                                <div>
                                                    <span className="font-medium">{alloc.studentName}</span>
                                                    <span className="text-gray-600 ml-2">→ {alloc.practicalName}</span>
                                                    {alloc.courseCode && <span className="text-purple-600 ml-2">({alloc.courseCode})</span>}
                                                </div>
                                                <div className="text-sm text-gray-600">
                                                    Preference #{alloc.preferenceRank} • Round {alloc.round}
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                );
            };

            if (isLoading) {
                return (
                    <div className="min-h-screen bg-gray-100 flex items-center justify-center">
                        <div className="text-center">
                            <RefreshCw className="animate-spin mx-auto mb-4 text-purple-600" size={40} />
                            <p className="text-gray-600">Loading data from Google Sheets...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-100">
                    <ConnectionStatus />
                    <div className="bg-white shadow-sm border-b">
                        <div className="max-w-6xl mx-auto px-6 py-4">
                            <div className="flex justify-between items-center">
                                <h1 className="text-2xl font-bold text-gray-800">Imperial GTA Allocator</h1>
                                <div className="flex space-x-2">
                                    <button
                                        onClick={() => setView('student')}
                                        className={`px-4 py-2 rounded flex items-center ${
                                            view === 'student' 
                                                ? 'bg-blue-600 text-white' 
                                                : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                        }`}
                                    >
                                        <Users size={20} className="mr-2" />
                                        Student View
                                    </button>
                                    <button
                                        onClick={() => setView('admin')}
                                        className={`px-4 py-2 rounded flex items-center ${
                                            view === 'admin' 
                                                ? 'bg-purple-600 text-white' 
                                                : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                        }`}
                                    >
                                        <Settings size={20} className="mr-2" />
                                        Admin View
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    {view === 'student' ? <StudentView /> : <AdminView />}
                </div>
            );
        };

        ReactDOM.render(<GTAAllocator />, document.getElementById('root'));
    </script>
</body>
</html>
