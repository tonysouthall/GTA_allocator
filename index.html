<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Imperial GTA Allocator</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const storage = {
            async get(key) {
                const value = localStorage.getItem(key);
                return value ? { value } : null;
            },
            async set(key, value) {
                localStorage.setItem(key, value);
                return { key, value };
            }
        };

        // Available expertise tags - Admin can customize these
        const DEFAULT_EXPERTISE_TAGS = [
            'Molecular Biology',
            'Genetics', 
            'Cell Biology',
            'Biochemistry',
            'Microbiology',
            'Neuroscience',
            'Ecology',
            'Bioinformatics',
            'Physiology',
            'Other'
        ];

        const GTAAllocator = () => {
            const [view, setView] = useState('student');
            const [isAdminAuthenticated, setIsAdminAuthenticated] = useState(false);
            const [practicals, setPracticals] = useState([]);
            const [preferences, setPreferences] = useState([]);
            const [submissions, setSubmissions] = useState([]);
            const [allocations, setAllocations] = useState([]);
            const [expertiseTags, setExpertiseTags] = useState(DEFAULT_EXPERTISE_TAGS);
            const [maxSlotsPerStudent, setMaxSlotsPerStudent] = useState(3);
            
            const getAdminPassword = () => atob('==QNyAjMTBFR'.split('').reverse().join(''));

            useEffect(() => {
                const loadData = async () => {
                    try {
                        const [practicalsData, submissionsData, allocationsData, tagsData, maxSlotsData] = await Promise.all([
                            storage.get('practicals').catch(() => null),
                            storage.get('submissions').catch(() => null),
                            storage.get('allocations').catch(() => null),
                            storage.get('expertiseTags').catch(() => null),
                            storage.get('maxSlotsPerStudent').catch(() => null)
                        ]);

                        if (practicalsData) setPracticals(JSON.parse(practicalsData.value));
                        if (submissionsData) setSubmissions(JSON.parse(submissionsData.value));
                        if (allocationsData) setAllocations(JSON.parse(allocationsData.value));
                        if (tagsData) setExpertiseTags(JSON.parse(tagsData.value));
                        if (maxSlotsData) setMaxSlotsPerStudent(parseInt(maxSlotsData.value));
                    } catch (error) {
                        console.error('Error loading data:', error);
                    }
                };
                loadData();
            }, []);

            const saveData = async (key, data) => {
                try {
                    await storage.set(key, JSON.stringify(data));
                } catch (error) {
                    console.error(\`Error saving \${key}:\`, error);
                }
            };

            const addPractical = (practical) => {
                const newPracticals = [...practicals, { 
                    ...practical, 
                    id: Date.now().toString(),
                    deadline: practical.deadline || new Date(Date.now() + 14*24*60*60*1000).toISOString().split('T')[0], // Default 2 weeks
                    tags: practical.tags || []
                }];
                setPracticals(newPracticals);
                saveData('practicals', newPracticals);
            };

            const updatePractical = (id, updates) => {
                const newPracticals = practicals.map(p => p.id === id ? { ...p, ...updates } : p);
                setPracticals(newPracticals);
                saveData('practicals', newPracticals);
            };

            const deletePractical = (id) => {
                const newPracticals = practicals.filter(p => p.id !== id);
                setPracticals(newPracticals);
                saveData('practicals', newPracticals);
            };

            const submitPreferences = async () => {
                const studentName = document.getElementById('student-name-input')?.value || '';
                const studentEmail = document.getElementById('student-email-input')?.value || '';
                
                // Get selected expertise tags
                const selectedTags = Array.from(document.querySelectorAll('input[name="expertise"]:checked'))
                    .map(cb => cb.value);
                
                if (!studentName || !studentEmail || preferences.length === 0) {
                    alert('Please fill in your name, email, and select at least one preference');
                    return;
                }

                if (selectedTags.length === 0) {
                    alert('Please select at least one area of expertise/interest');
                    return;
                }

                const submission = {
                    id: Date.now().toString(),
                    name: studentName,
                    email: studentEmail,
                    preferences: preferences,
                    expertise: selectedTags,
                    timestamp: new Date().toISOString(),
                    previousHours: 0
                };

                const newSubmissions = [...submissions, submission];
                setSubmissions(newSubmissions);
                await saveData('submissions', newSubmissions);
                
                alert('Preferences submitted successfully!');
                document.getElementById('student-name-input').value = '';
                document.getElementById('student-email-input').value = '';
                document.querySelectorAll('input[name="expertise"]:checked').forEach(cb => cb.checked = false);
                setPreferences([]);
            };

            const runAllocation = () => {
                if (submissions.length === 0 || practicals.length === 0) {
                    alert('Need both practicals and student submissions to run allocation');
                    return;
                }

                const newAllocations = [];
                const studentAllocations = {};
                const practicalSlots = {};

                submissions.forEach(s => {
                    studentAllocations[s.email] = [];
                });
                practicals.forEach(p => {
                    practicalSlots[p.id] = p.slots;
                });

                // Sort by previous hours first, then by expertise match
                const sortedSubmissions = [...submissions].sort((a, b) => {
                    const hoursDiff = (a.previousHours || 0) - (b.previousHours || 0);
                    if (hoursDiff !== 0) return hoursDiff;
                    return 0;
                });

                for (let round = 0; round < maxSlotsPerStudent; round++) {
                    for (const submission of sortedSubmissions) {
                        if (studentAllocations[submission.email].length >= maxSlotsPerStudent) continue;

                        // Score preferences by expertise match
                        const scoredPrefs = submission.preferences.map(prefId => {
                            const practical = practicals.find(p => p.id === prefId);
                            if (!practical) return { prefId, score: 0 };
                            
                            // Check expertise match
                            const matchCount = practical.tags?.filter(tag => 
                                submission.expertise?.includes(tag)
                            ).length || 0;
                            
                            return { 
                                prefId, 
                                score: matchCount,
                                rank: submission.preferences.indexOf(prefId)
                            };
                        }).sort((a, b) => {
                            // Prioritize by preference rank first, then expertise
                            if (a.rank !== b.rank) return a.rank - b.rank;
                            return b.score - a.score;
                        });

                        for (const { prefId, score } of scoredPrefs) {
                            const practical = practicals.find(p => p.id === prefId);
                            
                            if (practical && 
                                practicalSlots[prefId] > 0 && 
                                !studentAllocations[submission.email].includes(prefId)) {
                                
                                newAllocations.push({
                                    studentEmail: submission.email,
                                    studentName: submission.name,
                                    practicalId: prefId,
                                    practicalName: practical.name,
                                    practicalDate: practical.date,
                                    round: round + 1,
                                    preferenceRank: submission.preferences.indexOf(prefId) + 1,
                                    expertiseMatch: score
                                });

                                studentAllocations[submission.email].push(prefId);
                                practicalSlots[prefId]--;
                                break;
                            }
                        }
                    }
                }

                setAllocations(newAllocations);
                saveData('allocations', newAllocations);
                alert(\`Allocation complete! \${newAllocations.length} slots allocated.\`);
            };

            const exportAllocations = () => {
                const csv = [
                    ['Student Name', 'Student Email', 'Practical', 'Date', 'Preference Rank', 'Expertise Match', 'Allocation Round'],
                    ...allocations.map(a => [
                        a.studentName,
                        a.studentEmail,
                        a.practicalName,
                        a.practicalDate,
                        a.preferenceRank,
                        a.expertiseMatch || 0,
                        a.round
                    ])
                ].map(row => row.join(',')).join('\n');

                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'gta-allocations.csv';
                a.click();
            };

            const StudentView = () => {
                // Filter practicals by deadline
                const availablePracticals = practicals.filter(p => {
                    const deadline = new Date(p.deadline);
                    return new Date() < deadline;
                });

                const checkEmail = document.getElementById('student-email-input')?.value || '';
                const myAllocations = allocations.filter(a => a.studentEmail === checkEmail);

                return (
                    <div className="max-w-4xl mx-auto p-6">
                        <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                            <h2 className="text-2xl font-bold text-blue-900 mb-2">GTA Practical Allocation System</h2>
                            <p className="text-blue-700">
                                Select practicals that are still open for signup
                            </p>
                        </div>

                        {availablePracticals.length > 0 ? (
                            <div className="bg-white rounded-lg shadow-md p-6 mb-6">
                                <h3 className="text-xl font-semibold mb-4">Submit Your Preferences</h3>
                                
                                <div className="mb-4">
                                    <label className="block text-sm font-medium mb-2">Your Name</label>
                                    <input
                                        id="student-name-input"
                                        type="text"
                                        className="w-full p-2 border rounded"
                                        placeholder="Full name"
                                    />
                                </div>

                                <div className="mb-4">
                                    <label className="block text-sm font-medium mb-2">Your Email</label>
                                    <input
                                        id="student-email-input"
                                        type="email"
                                        className="w-full p-2 border rounded"
                                        placeholder="your.email@imperial.ac.uk"
                                    />
                                </div>

                                <div className="mb-4">
                                    <label className="block text-sm font-medium mb-2">Your Areas of Expertise/Interest (select all that apply)</label>
                                    <div className="grid grid-cols-2 gap-2 p-3 bg-gray-50 rounded">
                                        {expertiseTags.map(tag => (
                                            <label key={tag} className="flex items-center space-x-2 cursor-pointer">
                                                <input type="checkbox" name="expertise" value={tag} className="w-4 h-4" />
                                                <span className="text-sm">{tag}</span>
                                            </label>
                                        ))}
                                    </div>
                                </div>

                                <div className="mb-4">
                                    <label className="block text-sm font-medium mb-2">
                                        Rank Your Preferences (click to select, max {maxSlotsPerStudent} selections)
                                    </label>
                                    <div className="space-y-2">
                                        {availablePracticals.map(practical => {
                                            const isSelected = preferences.includes(practical.id);
                                            const rank = preferences.indexOf(practical.id) + 1;
                                            const deadline = new Date(practical.deadline);
                                            const daysLeft = Math.ceil((deadline - new Date()) / (1000 * 60 * 60 * 24));
                                            
                                            return (
                                                <div
                                                    key={practical.id}
                                                    onClick={() => {
                                                        if (isSelected) {
                                                            setPreferences(preferences.filter(id => id !== practical.id));
                                                        } else if (preferences.length < maxSlotsPerStudent) {
                                                            setPreferences([...preferences, practical.id]);
                                                        }
                                                    }}
                                                    className={\`p-3 border rounded cursor-pointer transition \${
                                                        isSelected 
                                                            ? 'bg-blue-100 border-blue-500' 
                                                            : 'bg-gray-50 hover:bg-gray-100'
                                                    }\`}
                                                >
                                                    <div className="flex justify-between items-start">
                                                        <div className="flex-1">
                                                            <div className="font-medium">{practical.name}</div>
                                                            <div className="text-sm text-gray-600">
                                                                {new Date(practical.date).toLocaleDateString()} • {practical.slots} slots available
                                                            </div>
                                                            <div className="text-xs text-gray-500 mt-1">
                                                                Signup deadline: {deadline.toLocaleDateString()} ({daysLeft} days left)
                                                            </div>
                                                            {practical.tags && practical.tags.length > 0 && (
                                                                <div className="flex flex-wrap gap-1 mt-2">
                                                                    {practical.tags.map(tag => (
                                                                        <span key={tag} className="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded">
                                                                            {tag}
                                                                        </span>
                                                                    ))}
                                                                </div>
                                                            )}
                                                        </div>
                                                        {isSelected && (
                                                            <div className="bg-blue-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold ml-3">
                                                                {rank}
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>

                                {preferences.length > 0 && (
                                    <div className="mb-4 p-3 bg-green-50 border border-green-200 rounded">
                                        <div className="font-medium text-green-900 mb-2">Your ranked preferences:</div>
                                        <ol className="list-decimal list-inside text-green-800">
                                            {preferences.map((prefId) => {
                                                const practical = practicals.find(p => p.id === prefId);
                                                return <li key={prefId}>{practical?.name}</li>;
                                            })}
                                        </ol>
                                    </div>
                                )}

                                <button
                                    onClick={submitPreferences}
                                    className="w-full bg-blue-600 text-white py-3 rounded font-medium hover:bg-blue-700"
                                >
                                    Submit Preferences
                                </button>
                            </div>
                        ) : (
                            <div className="bg-gray-50 border border-gray-200 rounded-lg p-6 text-center">
                                <p className="text-gray-600">No practicals currently open for signup. Check back later or contact the DPS.</p>
                            </div>
                        )}

                        {myAllocations.length > 0 && (
                            <div className="bg-white rounded-lg shadow-md p-6 mt-6">
                                <h3 className="text-xl font-semibold mb-4">Your Allocated Practicals</h3>
                                <div className="space-y-2">
                                    {myAllocations.map((alloc, idx) => (
                                        <div key={idx} className="p-3 bg-green-50 border border-green-200 rounded">
                                            <div className="font-medium">{alloc.practicalName}</div>
                                            <div className="text-sm text-gray-600">
                                                {new Date(alloc.practicalDate).toLocaleDateString()} • 
                                                Preference rank: {alloc.preferenceRank}
                                                {alloc.expertiseMatch > 0 && \` • Matched \${alloc.expertiseMatch} expertise area(s)\`}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                );
            };

            const AdminView = () => {
                const [newPractical, setNewPractical] = useState({ 
                    name: '', 
                    date: '', 
                    slots: 5, 
                    deadline: '',
                    tags: []
                });
                const [editingPractical, setEditingPractical] = useState(null);
                const [newTag, setNewTag] = useState('');

                if (!isAdminAuthenticated) {
                    const checkPassword = () => {
                        const password = prompt('Enter admin password:');
                        if (password === getAdminPassword()) {
                            setIsAdminAuthenticated(true);
                        } else if (password !== null) {
                            alert('Incorrect password');
                        }
                    };

                    setTimeout(checkPassword, 100);

                    return (
                        <div className="max-w-md mx-auto p-6 mt-20">
                            <div className="bg-white rounded-lg shadow-md p-8 text-center">
                                <h2 className="text-2xl font-bold text-purple-900 mb-4">Admin Login Required</h2>
                                <p className="text-gray-600 mb-4">You'll be prompted for the admin password.</p>
                                <button
                                    onClick={checkPassword}
                                    className="bg-purple-600 text-white px-6 py-2 rounded hover:bg-purple-700"
                                >
                                    Enter Password
                                </button>
                                <p className="text-sm text-gray-500 mt-4">
                                    Password: DPS2025 • Contact DPS if you need help
                                </p>
                            </div>
                        </div>
                    );
                }

                return (
                    <div className="max-w-6xl mx-auto p-6">
                        <div className="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-6">
                            <div className="flex justify-between items-center">
                                <div>
                                    <h2 className="text-2xl font-bold text-purple-900 mb-2">Admin Dashboard</h2>
                                    <p className="text-purple-700">Manage practicals with individual deadlines and expertise matching</p>
                                </div>
                                <button
                                    onClick={() => {
                                        setIsAdminAuthenticated(false);
                                        setView('student');
                                    }}
                                    className="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700"
                                >
                                    Logout
                                </button>
                            </div>
                        </div>

                        <div className="bg-white rounded-lg shadow-md p-6 mb-6">
                            <h3 className="text-xl font-semibold mb-4">System Settings</h3>
                            
                            <div className="mb-4">
                                <label className="block text-sm font-medium mb-2">Max Slots per Student</label>
                                <input
                                    type="number"
                                    min="1"
                                    max="10"
                                    value={maxSlotsPerStudent}
                                    onChange={(e) => {
                                        const val = parseInt(e.target.value);
                                        setMaxSlotsPerStudent(val);
                                        saveData('maxSlotsPerStudent', val);
                                    }}
                                    className="w-full p-2 border rounded"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium mb-2">Expertise Tags (for matching students to practicals)</label>
                                <div className="flex gap-2 mb-2">
                                    <input
                                        type="text"
                                        value={newTag}
                                        onChange={(e) => setNewTag(e.target.value)}
                                        placeholder="Add new tag"
                                        className="flex-1 p-2 border rounded"
                                    />
                                    <button
                                        onClick={() => {
                                            if (newTag && !expertiseTags.includes(newTag)) {
                                                const newTags = [...expertiseTags, newTag];
                                                setExpertiseTags(newTags);
                                                saveData('expertiseTags', newTags);
                                                setNewTag('');
                                            }
                                        }}
                                        className="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700"
                                    >
                                        Add Tag
                                    </button>
                                </div>
                                <div className="flex flex-wrap gap-2">
                                    {expertiseTags.map(tag => (
                                        <span key={tag} className="bg-purple-100 text-purple-700 px-3 py-1 rounded-full text-sm flex items-center gap-2">
                                            {tag}
                                            <button
                                                onClick={() => {
                                                    const newTags = expertiseTags.filter(t => t !== tag);
                                                    setExpertiseTags(newTags);
                                                    saveData('expertiseTags', newTags);
                                                }}
                                                className="text-purple-900 hover:text-purple-600"
                                            >
                                                ×
                                            </button>
                                        </span>
                                    ))}
                                </div>
                            </div>
                        </div>

                        <div className="bg-white rounded-lg shadow-md p-6 mb-6">
                            <h3 className="text-xl font-semibold mb-4">Add Practical</h3>
                            
                            <div className="grid grid-cols-2 gap-4 mb-4">
                                <div className="col-span-2">
                                    <label className="block text-sm font-medium mb-2">Practical Name</label>
                                    <input
                                        type="text"
                                        value={newPractical.name}
                                        onChange={(e) => setNewPractical({ ...newPractical, name: e.target.value })}
                                        className="w-full p-2 border rounded"
                                        placeholder="e.g., Genetics Lab Week 3"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium mb-2">Practical Date</label>
                                    <input
                                        type="date"
                                        value={newPractical.date}
                                        onChange={(e) => setNewPractical({ ...newPractical, date: e.target.value })}
                                        className="w-full p-2 border rounded"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium mb-2">Signup Deadline</label>
                                    <input
                                        type="date"
                                        value={newPractical.deadline}
                                        onChange={(e) => setNewPractical({ ...newPractical, deadline: e.target.value })}
                                        className="w-full p-2 border rounded"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium mb-2">GTA Slots Needed</label>
                                    <input
                                        type="number"
                                        min="1"
                                        value={newPractical.slots}
                                        onChange={(e) => setNewPractical({ ...newPractical, slots: parseInt(e.target.value) })}
                                        className="w-full p-2 border rounded"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium mb-2">Relevant Expertise Tags</label>
                                    <div className="border rounded p-2 max-h-32 overflow-y-auto">
                                        {expertiseTags.map(tag => (
                                            <label key={tag} className="flex items-center space-x-2 mb-1">
                                                <input 
                                                    type="checkbox"
                                                    checked={newPractical.tags?.includes(tag)}
                                                    onChange={(e) => {
                                                        const tags = e.target.checked
                                                            ? [...(newPractical.tags || []), tag]
                                                            : (newPractical.tags || []).filter(t => t !== tag);
                                                        setNewPractical({ ...newPractical, tags });
                                                    }}
                                                    className="w-4 h-4"
                                                />
                                                <span className="text-sm">{tag}</span>
                                            </label>
                                        ))}
                                    </div>
                                </div>
                            </div>

                            <button
                                onClick={() => {
                                    if (newPractical.name && newPractical.date && newPractical.deadline) {
                                        addPractical(newPractical);
                                        setNewPractical({ name: '', date: '', slots: 5, deadline: '', tags: [] });
                                    } else {
                                        alert('Please fill in all required fields');
                                    }
                                }}
                                className="bg-purple-600 text-white px-6 py-2 rounded hover:bg-purple-700"
                            >
                                Add Practical
                            </button>
                        </div>

                        <div className="bg-white rounded-lg shadow-md p-6 mb-6">
                            <h3 className="text-xl font-semibold mb-4">Current Practicals ({practicals.length})</h3>
                            {practicals.length === 0 ? (
                                <p className="text-gray-500">No practicals added yet</p>
                            ) : (
                                <div className="space-y-3">
                                    {practicals.map(practical => {
                                        const deadline = new Date(practical.deadline);
                                        const isOpen = new Date() < deadline;
                                        
                                        return (
                                            <div key={practical.id} className="border rounded p-4">
                                                {editingPractical === practical.id ? (
                                                    <div className="space-y-2">
                                                        <input
                                                            type="text"
                                                            defaultValue={practical.name}
                                                            onBlur={(e) => updatePractical(practical.id, { name: e.target.value })}
                                                            className="w-full p-2 border rounded font-medium"
                                                        />
                                                        <div className="grid grid-cols-3 gap-2">
                                                            <input
                                                                type="date"
                                                                defaultValue={practical.date}
                                                                onBlur={(e) => updatePractical(practical.id, { date: e.target.value })}
                                                                className="p-2 border rounded text-sm"
                                                            />
                                                            <input
                                                                type="date"
                                                                defaultValue={practical.deadline}
                                                                onBlur={(e) => updatePractical(practical.id, { deadline: e.target.value })}
                                                                className="p-2 border rounded text-sm"
                                                            />
                                                            <input
                                                                type="number"
                                                                defaultValue={practical.slots}
                                                                onBlur={(e) => updatePractical(practical.id, { slots: parseInt(e.target.value) })}
                                                                className="p-2 border rounded text-sm"
                                                            />
                                                        </div>
                                                        <button
                                                            onClick={() => setEditingPractical(null)}
                                                            className="text-sm text-blue-600 hover:text-blue-800"
                                                        >
                                                            Done Editing
                                                        </button>
                                                    </div>
                                                ) : (
                                                    <>
                                                        <div className="flex justify-between items-start">
                                                            <div className="flex-1">
                                                                <div className="font-medium text-lg">{practical.name}</div>
                                                                <div className="text-sm text-gray-600 mt-1">
                                                                    Practical: {new Date(practical.date).toLocaleDateString()} • 
                                                                    Deadline: {deadline.toLocaleDateString()} • 
                                                                    {practical.slots} slots
                                                                </div>
                                                                <div className="text-xs mt-1">
                                                                    <span className={\`px-2 py-1 rounded \${isOpen ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}\`}>
                                                                        {isOpen ? 'Open for signup' : 'Signup closed'}
                                                                    </span>
                                                                </div>
                                                                {practical.tags && practical.tags.length > 0 && (
                                                                    <div className="flex flex-wrap gap-1 mt-2">
                                                                        {practical.tags.map(tag => (
                                                                            <span key={tag} className="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded">
                                                                                {tag}
                                                                            </span>
                                                                        ))}
                                                                    </div>
                                                                )}
                                                            </div>
                                                            <div className="flex gap-2 ml-4">
                                                                <button
                                                                    onClick={() => setEditingPractical(practical.id)}
                                                                    className="text-blue-600 hover:text-blue-800 px-3 py-1 border border-blue-300 rounded text-sm"
                                                                >
                                                                    Edit
                                                                </button>
                                                                <button
                                                                    onClick={() => {
                                                                        if (confirm('Delete this practical?')) {
                                                                            deletePractical(practical.id);
                                                                        }
                                                                    }}
                                                                    className="text-red-600 hover:text-red-800 px-3 py-1 border border-red-300 rounded text-sm"
                                                                >
                                                                    Delete
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                            )}
                        </div>

                        <div className="bg-white rounded-lg shadow-md p-6 mb-6">
                            <h3 className="text-xl font-semibold mb-4">Student Submissions ({submissions.length})</h3>
                            {submissions.length === 0 ? (
                                <p className="text-gray-500">No submissions yet</p>
                            ) : (
                                <div className="space-y-2">
                                    {submissions.map(sub => (
                                        <div key={sub.id} className="p-3 bg-blue-50 rounded">
                                            <div className="font-medium">{sub.name} ({sub.email})</div>
                                            <div className="text-sm text-gray-600">
                                                Submitted: {new Date(sub.timestamp).toLocaleString()}
                                            </div>
                                            {sub.expertise && sub.expertise.length > 0 && (
                                                <div className="text-sm mt-1">
                                                    <span className="font-medium">Expertise: </span>
                                                    {sub.expertise.join(', ')}
                                                </div>
                                            )}
                                            <div className="text-sm mt-1">
                                                <span className="font-medium">Preferences: </span>
                                                {sub.preferences.map((prefId, idx) => {
                                                    const practical = practicals.find(p => p.id === prefId);
                                                    return practical ? \`\${idx + 1}. \${practical.name}\` : '';
                                                }).join(' • ')}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>

                        <div className="bg-white rounded-lg shadow-md p-6 mb-6">
                            <h3 className="text-xl font-semibold mb-4">Run Allocation</h3>
                            <p className="text-gray-600 mb-4">
                                This will allocate students to practicals based on their preferences, previous hours worked, 
                                and expertise matching. Students with fewer historical hours get priority.
                            </p>
                            <button
                                onClick={runAllocation}
                                className="bg-green-600 text-white px-6 py-3 rounded font-medium hover:bg-green-700"
                            >
                                Run Fair Allocation Algorithm
                            </button>
                        </div>

                        {allocations.length > 0 && (
                            <div className="bg-white rounded-lg shadow-md p-6">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-xl font-semibold">Allocation Results ({allocations.length} total slots)</h3>
                                    <button
                                        onClick={exportAllocations}
                                        className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
                                    >
                                        Export CSV
                                    </button>
                                </div>
                                
                                <div className="grid grid-cols-4 gap-4 mb-4 p-4 bg-gray-50 rounded">
                                    <div>
                                        <div className="text-2xl font-bold text-blue-600">
                                            {new Set(allocations.map(a => a.studentEmail)).size}
                                        </div>
                                        <div className="text-sm text-gray-600">Students allocated</div>
                                    </div>
                                    <div>
                                        <div className="text-2xl font-bold text-green-600">
                                            {(allocations.reduce((sum, a) => sum + (a.preferenceRank === 1 ? 1 : 0), 0) / allocations.length * 100).toFixed(0)}%
                                        </div>
                                        <div className="text-sm text-gray-600">Got 1st choice</div>
                                    </div>
                                    <div>
                                        <div className="text-2xl font-bold text-purple-600">
                                            {(allocations.reduce((sum, a) => sum + (a.expertiseMatch || 0), 0) / allocations.length).toFixed(1)}
                                        </div>
                                        <div className="text-sm text-gray-600">Avg expertise match</div>
                                    </div>
                                    <div>
                                        <div className="text-2xl font-bold text-orange-600">
                                            {(allocations.length / submissions.length).toFixed(1)}
                                        </div>
                                        <div className="text-sm text-gray-600">Avg slots per student</div>
                                    </div>
                                </div>

                                <div className="space-y-2 max-h-96 overflow-y-auto">
                                    {allocations.map((alloc, idx) => (
                                        <div key={idx} className="p-3 bg-green-50 border border-green-200 rounded">
                                            <div className="flex justify-between">
                                                <div>
                                                    <span className="font-medium">{alloc.studentName}</span>
                                                    <span className="text-gray-600 ml-2">→ {alloc.practicalName}</span>
                                                </div>
                                                <div className="text-sm text-gray-600">
                                                    Pref #{alloc.preferenceRank} • 
                                                    Match: {alloc.expertiseMatch || 0} • 
                                                    Round {alloc.round}
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                );
            };

            return (
                <div className="min-h-screen bg-gray-100">
                    <div className="bg-white shadow-sm border-b">
                        <div className="max-w-6xl mx-auto px-6 py-4">
                            <div className="flex justify-between items-center">
                                <h1 className="text-2xl font-bold text-gray-800">Imperial GTA Allocator</h1>
                                <div className="flex space-x-2">
                                    <button
                                        onClick={() => setView('student')}
                                        className={\`px-4 py-2 rounded \${
                                            view === 'student' 
                                                ? 'bg-blue-600 text-white' 
                                                : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                        }\`}
                                    >
                                        Student View
                                    </button>
                                    <button
                                        onClick={() => setView('admin')}
                                        className={\`px-4 py-2 rounded \${
                                            view === 'admin' 
                                                ? 'bg-purple-600 text-white' 
                                                : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                        }\`}
                                    >
                                        Admin View
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    {view === 'student' ? <StudentView /> : <AdminView />}
                </div>
            );
        };

        ReactDOM.render(<GTAAllocator />, document.getElementById('root'));
    </script>
</body>
</html>
